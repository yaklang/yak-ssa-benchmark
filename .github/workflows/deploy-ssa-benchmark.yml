name: Deploy SSA Benchmark

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# ç¡®ä¿åŒä¸€æ—¶é—´åªè¿è¡Œä¸€ä¸ªéƒ¨ç½²ä»»åŠ¡
concurrency:
  group: deploy-ssa-benchmark
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-22.04

    env:
      APP_NAME: ssa-benchmark
      APP_PATH: apps/ssa-benchmark
      REPORT_VIEWER_SCRIPT: report_viewer.yak
      REPORT_VIEWER_SERVICE_NAME: yak-ssa-benchmark-report-viewer
      AUTO_RUNNER_SERVICE_NAME: ssa-benchmark-auto-runner
      AUTO_RUNNER_TIMER_NAME: ssa-benchmark-auto-runner.timer
      WORK_DIR: /root/yak-ssa-benchmark
      YAK_VERSION: 1.4.4-alpha1121a
      YAK_PATH: /usr/local/bin/yak-1.4.4-alpha1121a
      REPORT_VIEWER_PORT: ${{ secrets.SSA_BENCHMARK_REPORT_PORT }}
      REPORT_DIR: /root/ssa-benchmark-reports

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Print trigger information
        run: |
          echo "============================================"
          echo "éƒ¨ç½²åº”ç”¨: ${{ env.APP_NAME }}"
          echo "Report Viewer æœåŠ¡: ${{ env.REPORT_VIEWER_SERVICE_NAME }}"
          echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "åˆ†æ”¯: ${{ github.ref }}"
          echo "æäº¤: ${{ github.sha }}"
          echo "æ“ä½œè€…: ${{ github.actor }}"
          echo "============================================"

      - name: Download Yaklang Engine
        run: |
          echo "=== ä¸‹è½½ Yaklang å¼•æ“Ž v${{ env.YAK_VERSION }} ==="
          YAK_URL="https://yaklang.oss-accelerate.aliyuncs.com/yak/${{ env.YAK_VERSION }}/yak_linux_amd64"
          
          echo "ä¸‹è½½åœ°å€: $YAK_URL"
          wget --progress=dot:binary -O ./yak "$YAK_URL" 2>&1 | \
            awk '/[0-9]+%/{i++; if(i%3==0) print; next} {print}' || true
          
          if [ ! -f ./yak ]; then
            echo "ERROR: YAK å¼•æ“Žä¸‹è½½å¤±è´¥"
            exit 1
          fi
          
          chmod +x ./yak
          
          echo ""
          echo "=== ä¸‹è½½çš„æ–‡ä»¶ä¿¡æ¯ ==="
          ls -lh ./yak
          file ./yak
          
          echo ""
          echo "=== æµ‹è¯• YAK å¼•æ“Ž ==="
          ./yak version || echo "æ³¨æ„: æ­¤ç‰ˆæœ¬å¯èƒ½ä¸æ”¯æŒ version å‘½ä»¤"
          
          echo ""
          echo "âœ“ Yaklang å¼•æ“Žä¸‹è½½å¹¶éªŒè¯æˆåŠŸ"

      - name: Prepare SSH key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.EMBEDDING_HOST_PRIVATE_KEY }}
          SSH_HOST: ${{ secrets.EMBEDDING_HOST }}
        run: |
          echo "=== å‡†å¤‡ SSH éƒ¨ç½² ==="
          
          if [ -z "$SSH_PRIVATE_KEY" ] || [ -z "$SSH_HOST" ]; then
            echo "ERROR: SSH å‡­è¯æœªæ‰¾åˆ°"
            echo "è¯·ç¡®ä¿å·²è®¾ç½® EMBEDDING_HOST_PRIVATE_KEY å’Œ EMBEDDING_HOST secrets"
            exit 1
          fi
          
          # åˆ›å»ºç§é’¥æ–‡ä»¶
          echo "$SSH_PRIVATE_KEY" | tr -d '\r' > /tmp/deploy_pri
          chmod 600 /tmp/deploy_pri
          
          # éªŒè¯ç§é’¥æ ¼å¼
          if ! ssh-keygen -l -f /tmp/deploy_pri >/dev/null 2>&1; then
            echo "ERROR: SSH ç§é’¥æ ¼å¼æ— æ•ˆ"
            exit 1
          fi
          
          echo "âœ“ SSH å¯†é’¥å‡†å¤‡æˆåŠŸ"

      - name: Prepare environment configuration
        run: |
          echo "=== å‡†å¤‡çŽ¯å¢ƒé…ç½® ==="
      
          # åˆ›å»º Benchmark çŽ¯å¢ƒå˜é‡é…ç½®æ–‡ä»¶
          cat > /tmp/benchmark-config.env << 'EOF'
          # SSA Benchmark åº”ç”¨é…ç½®
          REPORT_DIR=${{ env.REPORT_DIR }}
          EOF
          
          # åˆ›å»º Report Viewer çŽ¯å¢ƒå˜é‡é…ç½®æ–‡ä»¶
          cat > /tmp/report-viewer-config.env << 'EOF'
          # SSA Benchmark Report Viewer é…ç½®
          REPORT_VIEWER_PORT=${{ env.REPORT_VIEWER_PORT }}
          REPORT_DIR=${{ env.REPORT_DIR }}
          EOF
          
          echo ""
          echo "çŽ¯å¢ƒé…ç½®ä¿¡æ¯:"
          if [ -n "${{ env.REPORT_VIEWER_PORT }}" ]; then
            echo "  REPORT_VIEWER_PORT: [å·²è®¾ç½®]"
          fi
          echo "  REPORT_DIR: ${{ env.REPORT_DIR }}"
          
          echo ""
          echo "âœ“ é…ç½®å‡†å¤‡æˆåŠŸ"

      - name: Deploy to remote server
        env:
          SSH_HOST: ${{ secrets.EMBEDDING_HOST }}
        run: |
          echo "=== éƒ¨ç½²åˆ°è¿œç¨‹æœåŠ¡å™¨ ==="
          echo "ç›®æ ‡æœåŠ¡å™¨: [å·²éšè—]"
          echo "åº”ç”¨: ${{ env.APP_NAME }}"
          
          # æ¸…ç†æ—§çš„åº”ç”¨ç›®å½•ï¼Œä¿ç•™æŠ¥å‘Šæ•°æ®
          echo ""
          echo "æ¸…ç†æ—§çš„åº”ç”¨ç›®å½•..."
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "
            # ä¿ç•™æŠ¥å‘Šæ•°æ®ç›®å½•
            if [ -d ${{ env.REPORT_DIR }} ]; then
              echo 'âœ“ æŠ¥å‘Šç›®å½•å·²å­˜åœ¨ï¼Œå°†ä¿ç•™'
            else
              mkdir -p ${{ env.REPORT_DIR }}
              echo 'âœ“ åˆ›å»ºæŠ¥å‘Šç›®å½•'
            fi
            
            # åˆ é™¤æ•´ä¸ªåº”ç”¨ç›®å½•
            if [ -d ${{ env.WORK_DIR }} ]; then
              rm -rf ${{ env.WORK_DIR }}
              echo 'ðŸ—‘ï¸ åˆ é™¤æ—§çš„åº”ç”¨ç›®å½•: ${{ env.WORK_DIR }}'
            fi
            
            # é‡æ–°åˆ›å»ºåº”ç”¨ç›®å½•ç»“æž„
            mkdir -p ${{ env.WORK_DIR }}/{${{ env.APP_PATH }},scripts,apps}
            echo 'âœ“ åˆ›å»ºæ–°çš„åº”ç”¨ç›®å½•'
          "
          
          # å‡†å¤‡å¾…ä¸Šä¼ çš„æ–‡ä»¶
          echo ""
          echo "=== å‡†å¤‡æ–‡ä»¶æ‰“åŒ… ==="
          
          # åˆ›å»ºä¸´æ—¶æ‰“åŒ…ç›®å½•
          PACKAGE_DIR="/tmp/ssa-benchmark-deploy"
          mkdir -p "$PACKAGE_DIR"/{apps,scripts,configs,app-files,project-configs}
          
          # 1. å¤åˆ¶é€šç”¨éƒ¨ç½²è„šæœ¬
          echo "å‡†å¤‡é€šç”¨éƒ¨ç½²è„šæœ¬..."
          cp ./apps/deploy-yak-app.sh "$PACKAGE_DIR/apps/"
          
          # 2. å¤åˆ¶ systemd å®‰è£…è„šæœ¬
          echo "å‡†å¤‡ systemd å®‰è£…è„šæœ¬..."
          cp ./scripts/install-yak-scripts-to-systemd.yak "$PACKAGE_DIR/scripts/"
          
          # 3. å¤åˆ¶åº”ç”¨æ–‡ä»¶ï¼ˆåªå¤åˆ¶æ–‡ä»¶ï¼Œä¸å¤åˆ¶ç›®å½•ï¼›è·³è¿‡ .md æ–‡ä»¶ï¼‰
          echo "å‡†å¤‡åº”ç”¨æ–‡ä»¶..."
          for file in ${{ env.APP_PATH }}/*; do
            if [ -f "$file" ]; then  # -f ç¡®ä¿åªå¤„ç†æ–‡ä»¶ï¼Œè‡ªåŠ¨è·³è¿‡ configs ç­‰ç›®å½•
              filename=$(basename "$file")
              if [[ "$filename" != *.md ]]; then
                echo "  â†’ $filename"
                cp "$file" "$PACKAGE_DIR/app-files/"
              fi
            fi
          done
          
          # 4. å¤åˆ¶é¡¹ç›®é…ç½®ç›®å½•ï¼ˆconfigs/ï¼‰
          echo "å‡†å¤‡é¡¹ç›®é…ç½®ç›®å½•..."
          if [ -d "${{ env.APP_PATH }}/configs" ]; then
            # å¤åˆ¶ configs ç›®å½•ä¸‹çš„æ‰€æœ‰å­ç›®å½•ï¼Œé¿å…åµŒå¥—
            cp -r "${{ env.APP_PATH }}/configs/"* "$PACKAGE_DIR/project-configs/" 2>/dev/null || echo "  âš  configs/ ç›®å½•ä¸ºç©º"
            echo "  â†’ configs/ ç›®å½•å†…å®¹å·²å¤åˆ¶"
          else
            echo "  âš  configs/ ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡"
          fi
          
          # 5. å¤åˆ¶çŽ¯å¢ƒé…ç½®æ–‡ä»¶
          echo "å‡†å¤‡çŽ¯å¢ƒé…ç½®æ–‡ä»¶..."
          cp /tmp/benchmark-config.env "$PACKAGE_DIR/configs/"
          cp /tmp/report-viewer-config.env "$PACKAGE_DIR/configs/"
          
          # æ‰“åŒ…åŽ‹ç¼©
          echo ""
          echo "=== åŽ‹ç¼©æ–‡ä»¶ ==="
          tar -czf /tmp/ssa-benchmark-deploy.tar.gz -C /tmp ssa-benchmark-deploy/
          
          # æ˜¾ç¤ºåŽ‹ç¼©åŒ…ä¿¡æ¯
          echo "åŽ‹ç¼©åŒ…ä¿¡æ¯:"
          ls -lh /tmp/ssa-benchmark-deploy.tar.gz
          
          # ä¸Šä¼ åŽ‹ç¼©åŒ…
          echo ""
          echo "=== ä¸Šä¼ åŽ‹ç¼©åŒ… ==="
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --upload-file /tmp/ssa-benchmark-deploy.tar.gz
          
          echo "âœ“ åŽ‹ç¼©åŒ…ä¸Šä¼ å®Œæˆ"
          
          # åœ¨æœåŠ¡å™¨ç«¯è§£åŽ‹
          echo ""
          echo "=== è§£åŽ‹æ–‡ä»¶åˆ°æœåŠ¡å™¨ ==="
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "cd /root && tar -xzf ssa-benchmark-deploy.tar.gz"
          
          # ç§»åŠ¨æ–‡ä»¶åˆ°ç›®æ ‡ä½ç½®
          echo ""
          echo "=== éƒ¨ç½²æ–‡ä»¶åˆ°ç›®æ ‡ä½ç½® ==="
          
          # ç§»åŠ¨é€šç”¨éƒ¨ç½²è„šæœ¬
          echo "éƒ¨ç½²é€šç”¨éƒ¨ç½²è„šæœ¬..."
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "mv /root/ssa-benchmark-deploy/apps/deploy-yak-app.sh ${{ env.WORK_DIR }}/apps/deploy-yak-app.sh && chmod +x ${{ env.WORK_DIR }}/apps/deploy-yak-app.sh"
          
          # ç§»åŠ¨ systemd å®‰è£…è„šæœ¬
          echo "éƒ¨ç½² systemd å®‰è£…è„šæœ¬..."
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "mv /root/ssa-benchmark-deploy/scripts/install-yak-scripts-to-systemd.yak ${{ env.WORK_DIR }}/scripts/install-yak-scripts-to-systemd.yak"
          
          # ç§»åŠ¨åº”ç”¨æ–‡ä»¶
          echo "éƒ¨ç½²åº”ç”¨æ–‡ä»¶..."
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "mv /root/ssa-benchmark-deploy/app-files/* ${{ env.WORK_DIR }}/${{ env.APP_PATH }}/"
          
          # è®¾ç½® bash è„šæœ¬æ‰§è¡Œæƒé™
          echo "è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™..."
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "chmod +x ${{ env.WORK_DIR }}/${{ env.APP_PATH }}/auto-benchmark.sh"
          
          # ç§»åŠ¨çŽ¯å¢ƒé…ç½®æ–‡ä»¶
          echo "éƒ¨ç½²çŽ¯å¢ƒé…ç½®æ–‡ä»¶..."
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "mv /root/ssa-benchmark-deploy/configs/benchmark-config.env ${{ env.WORK_DIR }}/${{ env.APP_PATH }}/.env.benchmark"
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "mv /root/ssa-benchmark-deploy/configs/report-viewer-config.env ${{ env.WORK_DIR }}/${{ env.APP_PATH }}/.env.report-viewer"
          
          # éƒ¨ç½²é¡¹ç›®é…ç½®ç›®å½•
          echo "éƒ¨ç½²é¡¹ç›®é…ç½®ç›®å½•..."
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "
            if [ -d /root/ssa-benchmark-deploy/project-configs ] && [ \"\$(ls -A /root/ssa-benchmark-deploy/project-configs 2>/dev/null)\" ]; then
              cp -r /root/ssa-benchmark-deploy/project-configs ${{ env.WORK_DIR }}/${{ env.APP_PATH }}/configs
              echo 'âœ“ é¡¹ç›®é…ç½®ç›®å½•å·²éƒ¨ç½²'
            else
              echo 'âš  é¡¹ç›®é…ç½®ç›®å½•ä¸ºç©ºï¼Œè·³è¿‡'
            fi
          "
          
          # æ¸…ç†æœåŠ¡å™¨ä¸Šçš„ä¸´æ—¶æ–‡ä»¶
          echo ""
          echo "=== æ¸…ç†ä¸´æ—¶æ–‡ä»¶ ==="
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "rm -rf /root/ssa-benchmark-deploy /root/ssa-benchmark-deploy.tar.gz"
          
          # æ¸…ç†æœ¬åœ°ä¸´æ—¶æ–‡ä»¶
          rm -rf /tmp/ssa-benchmark-deploy /tmp/ssa-benchmark-deploy.tar.gz
          
          echo "âœ“ ä¸´æ—¶æ–‡ä»¶å·²æ¸…ç†"
          
          # éªŒè¯ä¸Šä¼ çš„æ–‡ä»¶
          echo ""
          echo "=== éªŒè¯éƒ¨ç½²çš„æ–‡ä»¶ ==="
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "ls -lh ${{ env.WORK_DIR }}/${{ env.APP_PATH }}/ ${{ env.WORK_DIR }}/scripts/ ${{ env.WORK_DIR }}/apps/deploy-yak-app.sh"
          
          echo ""
          echo "éªŒè¯é…ç½®æ–‡ä»¶..."
       
          echo ""
          echo "éªŒè¯è„šæœ¬æ–‡ä»¶..."
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "test -x ${{ env.WORK_DIR }}/${{ env.APP_PATH }}/auto-benchmark.sh && echo 'âœ“ auto-benchmark.sh å·²éƒ¨ç½²å¹¶å¯æ‰§è¡Œ'"
          
          echo ""
          echo "âœ“ æ–‡ä»¶éƒ¨ç½²å®Œæˆ"

      - name: Deploy Report Viewer Service
        env:
          SSH_HOST: ${{ secrets.EMBEDDING_HOST }}
        run: |
          echo "=== éƒ¨ç½² Report Viewer æœåŠ¡ ==="
          
          DEPLOY_CMD="${{ env.WORK_DIR }}/apps/deploy-yak-app.sh \
            --service-name \"${{ env.REPORT_VIEWER_SERVICE_NAME }}\" \
            --main-script \"${{ env.APP_PATH }}/${{ env.REPORT_VIEWER_SCRIPT }}\" \
            --work-dir \"${{ env.WORK_DIR }}\" \
            --yak-version \"${{ env.YAK_VERSION }}\" \
            --yak-path \"${{ env.YAK_PATH }}\" \
            --config-file \"${{ env.APP_PATH }}/.env.report-viewer\" \
            --script-args \"--port \\\$REPORT_VIEWER_PORT --report-dir \\\$REPORT_DIR --frontend ${{ env.WORK_DIR }}/${{ env.APP_PATH }}/report-viewer.html\" \
            --verify-port \"${{ env.REPORT_VIEWER_PORT }}\" \
            --install-yak"
          
          # è„±æ•åŽçš„å‘½ä»¤ç”¨äºŽæ—¥å¿—æ˜¾ç¤º
          SAFE_DEPLOY_CMD=$(echo "$DEPLOY_CMD" | sed 's/--verify-port "[^"]*"/--verify-port [REDACTED]/g')
          
          echo "éƒ¨ç½²å‘½ä»¤:"
          echo "  ${SAFE_DEPLOY_CMD}"
          echo ""
          
          # æ‰§è¡Œéƒ¨ç½²
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "bash -c '${DEPLOY_CMD}'"
          
          if [ $? -ne 0 ]; then
            echo ""
            echo "ERROR: Report Viewer éƒ¨ç½²å¤±è´¥"
            exit 1
          fi
          
          echo ""
          echo "âœ“ Report Viewer éƒ¨ç½²æˆåŠŸ"

      - name: Deploy Auto Runner Service
        env:
          SSH_HOST: ${{ secrets.EMBEDDING_HOST }}
        run: |
          echo "=== éƒ¨ç½² Auto Runner å®šæ—¶æœåŠ¡ ==="
          
          # 1. å¤åˆ¶ service å’Œ timer æ–‡ä»¶åˆ° systemd ç›®å½•
          echo "Installing systemd service and timer files..."
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "cp ${{ env.WORK_DIR }}/${{ env.APP_PATH }}/ssa-benchmark-auto-runner.service /etc/systemd/system/"
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "cp ${{ env.WORK_DIR }}/${{ env.APP_PATH }}/ssa-benchmark-auto-runner.timer /etc/systemd/system/"
          
          # 2. è®¾ç½® bash è„šæœ¬æ‰§è¡Œæƒé™
          echo "Setting execute permission for bash script..."
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "chmod +x ${{ env.WORK_DIR }}/${{ env.APP_PATH }}/auto-benchmark.sh"
          
          # 3. é‡æ–°åŠ è½½ systemd
          echo "Reloading systemd daemon..."
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "systemctl daemon-reload"
          
          # 4. åœæ­¢æ—§çš„æœåŠ¡ï¼ˆå¦‚æžœæ­£åœ¨è¿è¡Œï¼‰
          echo "Stopping old services if running..."
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "systemctl stop ssa-benchmark-auto-runner.timer || true"
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "systemctl stop ssa-benchmark-auto-runner.service || true"
          
          # 5. å¯ç”¨å¹¶å¯åŠ¨ timer
          echo "Enabling and starting timer..."
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "systemctl enable ssa-benchmark-auto-runner.timer"
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "systemctl start ssa-benchmark-auto-runner.timer"
          
          # 6. éªŒè¯æœåŠ¡çŠ¶æ€
          echo ""
          echo "Checking timer status..."
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "systemctl status ssa-benchmark-auto-runner.timer --no-pager || true"
          
          echo ""
          echo "Listing active timers..."
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "systemctl list-timers ssa-benchmark-auto-runner.timer --no-pager || true"
          
          echo ""
          echo "âœ“ Auto Runner å®šæ—¶æœåŠ¡éƒ¨ç½²æˆåŠŸ"
          echo "  - æœåŠ¡åç§°: ssa-benchmark-auto-runner.service"
          echo "  - å®šæ—¶å™¨åç§°: ssa-benchmark-auto-runner.timer"
          echo "  - æ‰§è¡Œå‘¨æœŸ: æ¯ 5 åˆ†é’Ÿ"
          echo "  - è„šæœ¬è·¯å¾„: ${{ env.WORK_DIR }}/${{ env.APP_PATH }}/auto-benchmark.sh"

      - name: Verify deployment
        env:
          SSH_HOST: ${{ secrets.EMBEDDING_HOST }}
        run: |
          echo "=== éªŒè¯éƒ¨ç½² ==="
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          echo "ç­‰å¾…æœåŠ¡ç¨³å®š..."
          sleep 5
          
          # éªŒè¯ Report Viewer æœåŠ¡
          echo ""
          echo "æ£€æŸ¥ Report Viewer æœåŠ¡çŠ¶æ€..."
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "systemctl is-active ${{ env.REPORT_VIEWER_SERVICE_NAME }} && echo 'âœ“ Report Viewer æœåŠ¡å·²æ¿€æ´»' || echo 'âœ— Report Viewer æœåŠ¡æœªæ¿€æ´»'"
          
          echo ""
          echo "Report Viewer æœåŠ¡çŠ¶æ€è¯¦æƒ…..."
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "systemctl status ${{ env.REPORT_VIEWER_SERVICE_NAME }} --no-pager -l || true"
          
          # å¥åº·æ£€æŸ¥ Report Viewer
          echo ""
          echo "Report Viewer å¥åº·æ£€æŸ¥ (ç«¯å£ ${{ env.REPORT_VIEWER_PORT }})..."
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "curl -f http://127.0.0.1:${{ env.REPORT_VIEWER_PORT }}/ 2>/dev/null && echo 'âœ“ Report Viewer å“åº”æ­£å¸¸' || echo 'âš  Report Viewer å¥åº·æ£€æŸ¥å¤±è´¥'"
          
          # éªŒè¯ Auto Runner Timer
          echo ""
          echo "æ£€æŸ¥ Auto Runner Timer çŠ¶æ€..."
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "systemctl is-active ssa-benchmark-auto-runner.timer && echo 'âœ“ Auto Runner Timer å·²æ¿€æ´»' || echo 'âœ— Auto Runner Timer æœªæ¿€æ´»'"
          
          echo ""
          echo "Auto Runner Timer çŠ¶æ€è¯¦æƒ…..."
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "systemctl status ssa-benchmark-auto-runner.timer --no-pager -l || true"
          
          echo ""
          echo "ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´..."
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "systemctl list-timers ssa-benchmark-auto-runner.timer --no-pager || true"
          
          echo ""
          echo "â„¹ï¸  Auto Runner æ¯ 5 åˆ†é’Ÿè‡ªåŠ¨æ£€æŸ¥å¹¶æ‰§è¡Œæµ‹è¯•"
          
          # æ£€æŸ¥æŠ¥å‘Šç›®å½•
          echo ""
          echo "æ£€æŸ¥æŠ¥å‘Šç›®å½•..."
          ./yak ssh -H "$SSH_HOST" -i /tmp/deploy_pri --command "ls -lh ${{ env.REPORT_DIR }} && echo 'âœ“ æŠ¥å‘Šç›®å½•å­˜åœ¨' || echo 'âš  æŠ¥å‘Šç›®å½•ä¸å­˜åœ¨'"
          
          echo ""
          echo "âœ“ æœåŠ¡éªŒè¯å®Œæˆ"

      - name: Cleanup
        if: always()
        run: |
          echo "=== æ¸…ç† ==="
          rm -f /tmp/deploy_pri /tmp/benchmark-config.env /tmp/report-viewer-config.env /tmp/test-config.json /tmp/ssa-config.json
          echo "âœ“ æ¸…ç†å®Œæˆ"

      - name: Summary
        if: success()
        run: |
          echo "## âœ… SSA Benchmark éƒ¨ç½²æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "SSA æ¼æ´žæ£€æµ‹åŸºå‡†æµ‹è¯•ç³»ç»Ÿå·²æˆåŠŸéƒ¨ç½²åˆ°è¿œç¨‹æœåŠ¡å™¨ã€‚" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ éƒ¨ç½²è¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Report Viewer æœåŠ¡" >> $GITHUB_STEP_SUMMARY
          echo "- æœåŠ¡åç§°: \`${{ env.REPORT_VIEWER_SERVICE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- è„šæœ¬: \`${{ env.APP_PATH }}/${{ env.REPORT_VIEWER_SCRIPT }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- ç«¯å£: \`${{ env.REPORT_VIEWER_PORT }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- è®¿é—®æ–¹å¼: Web ç•Œé¢" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Auto Runner å®šæ—¶æœåŠ¡" >> $GITHUB_STEP_SUMMARY
          echo "- æœåŠ¡åç§°: \`${{ env.AUTO_RUNNER_SERVICE_NAME }}.service\`" >> $GITHUB_STEP_SUMMARY
          echo "- å®šæ—¶å™¨åç§°: \`${{ env.AUTO_RUNNER_TIMER_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- è„šæœ¬: \`${{ env.APP_PATH }}/auto-benchmark.sh\`" >> $GITHUB_STEP_SUMMARY
          echo "- è¿è¡Œæ¨¡å¼: å®šæ—¶ä»»åŠ¡ (æ¯ 5 åˆ†é’Ÿ)" >> $GITHUB_STEP_SUMMARY
          echo "- é…ç½®æ¥æº: GitHub Secrets" >> $GITHUB_STEP_SUMMARY
          echo "- åŠŸèƒ½: è‡ªåŠ¨æ£€æµ‹æ–°å¼•æ“Žç‰ˆæœ¬å¹¶æ‰§è¡Œæµ‹è¯•" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### å…±äº«é…ç½®" >> $GITHUB_STEP_SUMMARY
          echo "- æŠ¥å‘Šç›®å½•: \`${{ env.REPORT_DIR }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- å·¥ä½œç›®å½•: \`${{ env.WORK_DIR }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- å¼•æ“Žå­˜å‚¨: \`/root/yak-ssa-benchmark/ssa-benchmark-service/yak-engine\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š æž„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- æäº¤: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- åˆ†æ”¯: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- è§¦å‘è€…: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- YAK ç‰ˆæœ¬: \`${{ env.YAK_VERSION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ æœåŠ¡ç®¡ç†å‘½ä»¤" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Report Viewer æœåŠ¡" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# æŸ¥çœ‹æœåŠ¡çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "systemctl status ${{ env.REPORT_VIEWER_SERVICE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# æŸ¥çœ‹æœåŠ¡æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
          echo "journalctl -u ${{ env.REPORT_VIEWER_SERVICE_NAME }} -f" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# é‡å¯æœåŠ¡" >> $GITHUB_STEP_SUMMARY
          echo "systemctl restart ${{ env.REPORT_VIEWER_SERVICE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Auto Runner å®šæ—¶æœåŠ¡" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# æŸ¥çœ‹å®šæ—¶å™¨çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "systemctl status ${{ env.AUTO_RUNNER_TIMER_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# æŸ¥çœ‹ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´" >> $GITHUB_STEP_SUMMARY
          echo "systemctl list-timers ${{ env.AUTO_RUNNER_TIMER_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# æŸ¥çœ‹æœåŠ¡æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
          echo "journalctl -u ${{ env.AUTO_RUNNER_SERVICE_NAME }} -f" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# æŸ¥çœ‹è„šæœ¬æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
          echo "tail -f /root/yak-ssa-benchmark/ssa-benchmark-service/auto-benchmark.log" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# æ‰‹åŠ¨è§¦å‘ä¸€æ¬¡æ‰§è¡Œ" >> $GITHUB_STEP_SUMMARY
          echo "systemctl start ${{ env.AUTO_RUNNER_SERVICE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# åœæ­¢å®šæ—¶å™¨" >> $GITHUB_STEP_SUMMARY
          echo "systemctl stop ${{ env.AUTO_RUNNER_TIMER_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# å¯åŠ¨å®šæ—¶å™¨" >> $GITHUB_STEP_SUMMARY
          echo "systemctl start ${{ env.AUTO_RUNNER_TIMER_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ æ³¨æ„äº‹é¡¹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Auto Runner ä¼šæ¯ 5 åˆ†é’Ÿè‡ªåŠ¨æ£€æŸ¥æœ€æ–°å¼•æ“Žç‰ˆæœ¬" >> $GITHUB_STEP_SUMMARY
          echo "- å‘çŽ°æ–°ç‰ˆæœ¬æ—¶è‡ªåŠ¨ä¸‹è½½å¹¶æ‰§è¡Œæµ‹è¯•" >> $GITHUB_STEP_SUMMARY
          echo "- é…ç½®ä»Ž GitHub Secrets è‡ªåŠ¨éƒ¨ç½²åˆ°æœåŠ¡å™¨" >> $GITHUB_STEP_SUMMARY
          echo "- ä¸¤ä¸ªæœåŠ¡å…±äº«æŠ¥å‘Šç›®å½•: \`${{ env.REPORT_DIR }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Report Viewer æä¾› Web ç•Œé¢æŸ¥çœ‹æŠ¥å‘Šï¼ˆç«¯å£ \`${{ env.REPORT_VIEWER_PORT }}\`ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "- æµ‹è¯•ä¼šè‡ªåŠ¨æ£€æµ‹æ–°ç‰ˆæœ¬å¹¶æ‰§è¡Œå¤šé¡¹ç›®åŸºçº¿å¯¹æ¯”" >> $GITHUB_STEP_SUMMARY
          echo "- æ›´æ–°é…ç½®éœ€ä¿®æ”¹ GitHub Secrets åŽé‡æ–°éƒ¨ç½²" >> $GITHUB_STEP_SUMMARY
          echo "- æŸ¥çœ‹é…ç½®çŠ¶æ€: \`cat /root/yak-ssa-benchmark/ssa-benchmark-service/config.json\`" >> $GITHUB_STEP_SUMMARY
