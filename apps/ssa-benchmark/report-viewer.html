<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSA Baseline Report Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background: #f5f5f5;
            color: #333333;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .reports-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #667eea;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        thead {
            background: #f3f4f6;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            font-weight: 600;
            color: #374151;
        }

        tr:hover {
            background: #f9fafb;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: #22c55e;
            color: white;
        }

        .badge-failed {
            background: #ef4444;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow: auto;
        }

        .modal-content {
            max-width: 1200px;
            margin: 50px auto;
            background: white;
            border-radius: 10px;
            padding: 30px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            background: #f3f4f6;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .comparison-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .comparison-pass {
            border-left: 4px solid #22c55e;
        }

        .comparison-fail {
            border-left: 4px solid #ef4444;
        }

        .risk-list {
            max-height: 300px;
            overflow-y: auto;
            background: #f9fafb;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }

        .risk-detail {
            font-size: 12px;
            color: #666;
            padding: 8px;
            background: white;
            border-radius: 4px;
            margin-bottom: 6px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #ef4444;
        }

        code {
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“Š SSA Baseline Report Viewer</h1>
            <p>æŸ¥çœ‹å’Œåˆ†æSSAåŸºçº¿å¯¹æ¯”æŠ¥å‘Š</p>
        </header>

        <div class="reports-section">
            <h2 class="section-title">å¯¹æ¯”æŠ¥å‘Šåˆ—è¡¨</h2>
            
            <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
                <button class="btn btn-primary" onclick="refreshAll()">
                    <span>ğŸ”„</span>
                    <span>åˆ·æ–°</span>
                </button>
                <div style="flex: 1;"></div>
                <div style="color: #666; font-size: 14px;">
                    æ€»æŠ¥å‘Šæ•°: <strong id="totalReports">0</strong>
                </div>
            </div>
            
            <div id="reportsContainer">
                <div class="loading">
                    <p>åŠ è½½æŠ¥å‘Šä¸­...</p>
                </div>
            </div>
        </div>

        <!-- Report Detail Modal -->
        <div id="reportModal" class="modal">
            <div class="modal-content">
                <button class="modal-close" onclick="closeReportModal()">âœ• å…³é—­</button>
                <div id="reportDetailContent"></div>
            </div>
        </div>
    </div>

    <script>
        // Load data on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadReports();
        });

        // Load reports list
        function loadReports() {
            const container = document.getElementById('reportsContainer');
            container.innerHTML = '<div class="loading"><p>åŠ è½½æŠ¥å‘Šä¸­...</p></div>';

            fetch('/api/reports')
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        container.innerHTML = `<div class="error"><p>${data.message}</p></div>`;
                        return;
                    }

                    document.getElementById('totalReports').textContent = data.count;

                    if (data.reports.length === 0) {
                        container.innerHTML = '<div class="loading"><p>æœªæ‰¾åˆ°æŠ¥å‘Šæ–‡ä»¶</p></div>';
                        return;
                    }

                    // Build reports table
                    let html = `
                        <table>
                            <thead>
                                <tr>
                                    <th>ç”Ÿæˆæ—¶é—´</th>
                                    <th style="text-align: center;">æ€»ä½“ç»“æœ</th>
                                    <th style="text-align: center;">åŸºçº¿é£é™©æ•°</th>
                                    <th style="text-align: center;">å½“å‰é£é™©æ•°</th>
                                    <th style="text-align: center;">é€šè¿‡/å¤±è´¥</th>
                                    <th style="text-align: center;">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    data.reports.forEach(report => {
                        const passBadge = report.overall_pass ? 
                            '<span class="badge badge-success">âœ“ é€šè¿‡</span>' :
                            '<span class="badge badge-failed">âœ— å¤±è´¥</span>';

                        html += `
                            <tr>
                                <td>${report.generated_at || '-'}</td>
                                <td style="text-align: center;">${passBadge}</td>
                                <td style="text-align: center;">${report.baseline_total || 0}</td>
                                <td style="text-align: center;">${report.current_total || 0}</td>
                                <td style="text-align: center;">
                                    <span style="color: #22c55e;">${report.passed_comparisons || 0}</span> / 
                                    <span style="color: #ef4444;">${report.failed_comparisons || 0}</span>
                                </td>
                                <td style="text-align: center;">
                                    <button onclick="viewReport('${report.filename}')" class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;">æŸ¥çœ‹è¯¦æƒ…</button>
                                </td>
                            </tr>
                        `;
                    });

                    html += '</tbody></table>';
                    container.innerHTML = html;
                })
                .catch(error => {
                    console.error('Failed to load reports:', error);
                    container.innerHTML = `<div class="error"><p>åŠ è½½æŠ¥å‘Šå¤±è´¥: ${error.message}</p></div>`;
                });
        }

        // View report detail
        function viewReport(filename) {
            const modal = document.getElementById('reportModal');
            const content = document.getElementById('reportDetailContent');
            
            content.innerHTML = '<div class="loading"><p>åŠ è½½æŠ¥å‘Šè¯¦æƒ…ä¸­...</p></div>';
            modal.style.display = 'block';

            fetch(`/api/report?filename=${encodeURIComponent(filename)}`)
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        content.innerHTML = `<div class="error"><p>é”™è¯¯: ${data.message}</p></div>`;
                        return;
                    }

                    const report = data.report;
                    
                    // æ ¹æ® Schemaï¼Œoverall_pass åœ¨ summary ä¸­
                    const overallPass = report.summary && report.summary.overall_pass !== undefined ? report.summary.overall_pass : false;
                    
                    let html = `
                        <h2 style="margin-bottom: 20px; color: #667eea;">ğŸ“„ ${overallPass ? 'âœ“' : 'âœ—'} å¯¹æ¯”æŠ¥å‘Šè¯¦æƒ…</h2>
                        
                        <div class="info-grid">
                            <div><strong>æŠ¥å‘Šç±»å‹:</strong> ${report.report_type || '-'}</div>
                            <div><strong>ç”Ÿæˆæ—¶é—´:</strong> ${report.generated_at || '-'}</div>
                            <div><strong>åŸºçº¿æŠ¥å‘Šæ—¶é—´:</strong> ${report.baseline_info.report_time || '-'}</div>
                            <div><strong>å½“å‰æŠ¥å‘Šæ—¶é—´:</strong> ${report.current_info.report_time || '-'}</div>
                            <div><strong>ç¨‹åºåç§°:</strong> ${report.baseline_info.program_name || '-'}</div>
                            <div><strong>ç¨‹åºè¯­è¨€:</strong> ${report.baseline_info.program_lang || '-'}</div>
                            <div><strong>æ€»ä½“ç»“æœ:</strong> ${overallPass ? '<span style="color: #22c55e;">âœ“ é€šè¿‡</span>' : '<span style="color: #ef4444;">âœ— å¤±è´¥</span>'}</div>
                            <div><strong>å¯¹æ¯”é¡¹:</strong> é€šè¿‡ ${report.summary.passed_comparisons || 0} / å¤±è´¥ ${report.summary.failed_comparisons || 0}</div>
                        </div>

                        <h3 style="margin: 20px 0 10px 0; color: #667eea;">åŸºçº¿ç»Ÿè®¡</h3>
                        <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; text-align: center;">
                                <div><strong>æ€»è®¡:</strong> ${report.baseline_info.summary.total}</div>
                                <div style="color: #dc2626;"><strong>ä¸¥é‡:</strong> ${report.baseline_info.summary.critical}</div>
                                <div style="color: #f59e0b;"><strong>é«˜å±:</strong> ${report.baseline_info.summary.high}</div>
                                <div style="color: #3b82f6;"><strong>ä¸­å±:</strong> ${report.baseline_info.summary.medium}</div>
                                <div style="color: #6b7280;"><strong>ä½å±:</strong> ${report.baseline_info.summary.low}</div>
                            </div>
                        </div>

                        <h3 style="margin: 20px 0 10px 0; color: #667eea;">å½“å‰ç»Ÿè®¡</h3>
                        <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; text-align: center;">
                                <div><strong>æ€»è®¡:</strong> ${report.current_info.summary.total}</div>
                                <div style="color: #dc2626;"><strong>ä¸¥é‡:</strong> ${report.current_info.summary.critical}</div>
                                <div style="color: #f59e0b;"><strong>é«˜å±:</strong> ${report.current_info.summary.high}</div>
                                <div style="color: #3b82f6;"><strong>ä¸­å±:</strong> ${report.current_info.summary.medium}</div>
                                <div style="color: #6b7280;"><strong>ä½å±:</strong> ${report.current_info.summary.low}</div>
                            </div>
                        </div>

                        <h3 style="margin: 20px 0 10px 0; color: #667eea;">ğŸ“Š å„çº§åˆ«è¯¦ç»†å¯¹æ¯”</h3>
                    `;

                    // æ ¹æ® Schemaï¼Œå­—æ®µåæ˜¯ comparisons è€Œä¸æ˜¯ comparison_results
                    const comparisons = report.comparisons || [];
                    
                    if (comparisons.length > 0) {
                        // å®šä¹‰ä¸¥é‡çº§åˆ«çš„é¢œè‰²å’Œå›¾æ ‡
                        const severityConfig = {
                            'critical': { color: '#dc2626', icon: 'ğŸ”´', label: 'ä¸¥é‡' },
                            'high': { color: '#f59e0b', icon: 'ğŸŸ ', label: 'é«˜å±' },
                            'medium': { color: '#3b82f6', icon: 'ğŸŸ¡', label: 'ä¸­å±' },
                            'low': { color: '#6b7280', icon: 'âšª', label: 'ä½å±' },
                            'info': { color: '#9ca3af', icon: 'âšª', label: 'ä¿¡æ¯' }
                        };

                        comparisons.forEach((comp, index) => {
                            const compClass = comp.pass ? 'comparison-pass' : 'comparison-fail';
                            const statusBadge = comp.pass ? 
                                '<span class="badge badge-success">âœ“ é€šè¿‡</span>' : 
                                '<span class="badge badge-failed">âœ— å¤±è´¥</span>';
                            
                            const config = severityConfig[comp.severity] || severityConfig['info'];
                            const diff = comp.current_count - comp.baseline_count;
                            let diffIndicator;
                            if (diff > 0) {
                                diffIndicator = `<span style="color: #ef4444;">+${diff}</span>`;
                            } else if (diff < 0) {
                                diffIndicator = `<span style="color: #22c55e;">${diff}</span>`;
                            } else {
                                diffIndicator = `<span style="color: #6b7280;">0</span>`;
                            }
                            
                            html += `
                                <div class="comparison-item ${compClass}" style="border-left-color: ${config.color}; border-left-width: 5px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                        <h4 style="margin: 0; text-transform: uppercase; color: ${config.color};">
                                            ${config.icon} ${config.label} (${comp.severity.toUpperCase()})
                                        </h4>
                                        ${statusBadge}
                                    </div>
                                    
                                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; background: #f9fafb; padding: 10px; border-radius: 6px; margin-bottom: 10px;">
                                        <div style="text-align: center;">
                                            <div style="font-size: 11px; color: #6b7280;">åŸºçº¿</div>
                                            <div style="font-size: 20px; font-weight: bold; color: ${config.color};">${comp.baseline_count}</div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 11px; color: #6b7280;">å½“å‰</div>
                                            <div style="font-size: 20px; font-weight: bold; color: ${config.color};">${comp.current_count}</div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 11px; color: #6b7280;">å·®å¼‚</div>
                                            <div style="font-size: 18px; font-weight: bold;">${diffIndicator}</div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 11px; color: #6b7280;">åŒ¹é…</div>
                                            <div style="font-size: 20px; font-weight: bold; color: #22c55e;">${comp.matched_count}</div>
                                        </div>
                                    </div>
                            `;

                            // æ˜¾ç¤ºç¼ºå¤±çš„é£é™© (åŸºçº¿æœ‰ä½†å½“å‰æ²¡æœ‰ - å¯èƒ½å·²ä¿®å¤)
                            const missingCount = comp.missing_count || (comp.missing ? comp.missing.length : 0);
                            if (missingCount > 0) {
                                html += `
                                    <div style="margin-top: 15px; padding: 10px; background: #fef2f2; border-left: 3px solid #ef4444; border-radius: 4px;">
                                        <strong style="color: #ef4444; font-size: 14px;">âŒ ç¼ºå¤±çš„é£é™© (${missingCount}ä¸ª) - åŸºçº¿ä¸­å­˜åœ¨ä½†å½“å‰æ‰«æç¼ºå¤±</strong>
                                `;
                                if (comp.missing && comp.missing.length > 0) {
                                    html += '<div class="risk-list" style="margin-top: 10px;">';
                                    comp.missing.forEach(risk => {
                                        html += `
                                            <div class="risk-detail" style="background: white;">
                                                <div><strong style="color: #dc2626;">${risk.title}</strong></div>
                                                <div style="margin-top: 4px;"><strong>æ–‡ä»¶:</strong> <code>${risk.file}</code></div>
                                                <div><strong>è¡Œå·:</strong> ${risk.line}</div>
                                                <div><strong>è§„åˆ™:</strong> ${risk.rule_name}</div>
                                                <div style="font-size: 11px; color: #9ca3af; margin-top: 4px;">ç‰¹å¾å“ˆå¸Œ: ${risk.feature_hash}</div>
                                            </div>
                                        `;
                                    });
                                    html += '</div>';
                                }
                                html += '</div>';
                            }

                            // æ˜¾ç¤ºæ–°å¢çš„é£é™© (å½“å‰æœ‰ä½†åŸºçº¿æ²¡æœ‰ - å¯èƒ½æ˜¯æ–°å¼•å…¥çš„é—®é¢˜)
                            const newCount = comp.new_count || (comp.new ? comp.new.length : 0);
                            if (newCount > 0) {
                                html += `
                                    <div style="margin-top: 15px; padding: 10px; background: #eff6ff; border-left: 3px solid #3b82f6; border-radius: 4px;">
                                        <strong style="color: #3b82f6; font-size: 14px;">â• æ–°å¢çš„é£é™© (${newCount}ä¸ª) - å½“å‰æ‰«ææ–°å‘ç°</strong>
                                `;
                                if (comp.new && comp.new.length > 0) {
                                    html += '<div class="risk-list" style="margin-top: 10px;">';
                                    comp.new.forEach(risk => {
                                        html += `
                                            <div class="risk-detail" style="background: white;">
                                                <div><strong style="color: #2563eb;">${risk.title}</strong></div>
                                                <div style="margin-top: 4px;"><strong>æ–‡ä»¶:</strong> <code>${risk.file}</code></div>
                                                <div><strong>è¡Œå·:</strong> ${risk.line}</div>
                                                <div><strong>è§„åˆ™:</strong> ${risk.rule_name}</div>
                                                <div style="font-size: 11px; color: #9ca3af; margin-top: 4px;">ç‰¹å¾å“ˆå¸Œ: ${risk.feature_hash}</div>
                                            </div>
                                        `;
                                    });
                                    html += '</div>';
                                }
                                html += '</div>';
                            }

                            // åŒ¹é…çš„é£é™©åªæ˜¾ç¤ºç»Ÿè®¡,ä¸æ˜¾ç¤ºè¯¦æƒ…(é¿å…å†—ä½™)
                            if (comp.matched_count > 0) {
                                html += `
                                    <div style="margin-top: 15px; padding: 10px; background: #f0fdf4; border-left: 3px solid #22c55e; border-radius: 4px;">
                                        <strong style="color: #22c55e; font-size: 14px;">âœ“ åŒ¹é…çš„é£é™© (${comp.matched_count}ä¸ª)</strong>
                                        <div style="color: #6b7280; font-size: 13px; margin-top: 5px;">è¿™äº›é£é™©åœ¨åŸºçº¿å’Œå½“å‰æ‰«æä¸­éƒ½å­˜åœ¨ä¸”ç‰¹å¾ç›¸åŒ,æ— éœ€é‡ç‚¹å…³æ³¨</div>
                                    </div>
                                `;
                            }

                            html += '</div></div>';
                        });
                    }

                    content.innerHTML = html;
                })
                .catch(error => {
                    console.error('Failed to load report:', error);
                    content.innerHTML = `<div class="error"><p>åŠ è½½æŠ¥å‘Šå¤±è´¥: ${error.message}</p></div>`;
                });
        }

        // Close report modal
        function closeReportModal() {
            document.getElementById('reportModal').style.display = 'none';
        }

        // Refresh all data
        function refreshAll() {
            loadReports();
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('reportModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>
